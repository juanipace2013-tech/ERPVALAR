// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// AUTENTICACIÓN Y USUARIOS
// ========================================

enum UserRole {
  ADMIN
  GERENTE
  VENDEDOR
  CONTADOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(VENDEDOR)
  status        UserStatus @default(ACTIVE)
  avatar        String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // Business relations
  activities    Activity[]
  opportunities Opportunity[]
  quotes        Quote[]
  invoices      Invoice[]
  customersSalesPerson Customer[] @relation("CustomerSalesPerson")
  suppliersBuyer Supplier[] @relation("SupplierBuyer")

  // Accounting relations
  journalEntries JournalEntry[]

  // Inventory relations
  stockMovements StockMovement[]

  // Purchase relations
  purchaseOrders    PurchaseOrder[]
  purchaseInvoices  PurchaseInvoice[]
  supplierPayments  SupplierPayment[]

  // Customer relations
  customerReceipts  CustomerReceipt[]

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// CLIENTES
// ========================================

enum TaxCondition {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTO
  EXENTO
  CONSUMIDOR_FINAL
  NO_RESPONSABLE
  RESPONSABLE_NO_INSCRIPTO
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
}

enum CustomerType {
  BUSINESS
  INDIVIDUAL
}

model Customer {
  id              String         @id @default(cuid())
  // Datos básicos
  name            String
  businessName    String?        // Razón social
  type            CustomerType   @default(BUSINESS)

  // Datos fiscales argentinos
  cuit            String         @unique
  taxCondition    TaxCondition   @default(RESPONSABLE_INSCRIPTO)

  // Contacto
  email           String?
  phone           String?
  mobile          String?
  website         String?

  // Dirección
  address         String?
  city            String?
  province        String?        // Provincia argentina
  postalCode      String?
  country         String         @default("Argentina")

  // Configuración comercial
  status          CustomerStatus @default(ACTIVE)
  creditLimit     Decimal?       @db.Decimal(12, 2)
  creditCurrency  Currency?      @default(ARS)
  paymentTerms    Int?           // Días de plazo de pago
  discount        Decimal?       @db.Decimal(5, 2) // Descuento porcentual
  priceMultiplier Decimal        @default(1.0) @db.Decimal(5, 3) // Multiplicador de precio (ej: 1.2 = 20% markup)
  balance         Decimal        @default(0) @db.Decimal(15, 2) // Saldo actual del cliente

  // Vendedor asignado
  salesPersonId   String?
  salesPerson     User?          @relation("CustomerSalesPerson", fields: [salesPersonId], references: [id])

  // Metadatos
  notes           String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relaciones
  contacts        Contact[]
  opportunities   Opportunity[]
  quotes          Quote[]
  deliveryNotes   DeliveryNote[]
  invoices        Invoice[]
  activities      Activity[]
  receipts        Receipt[]
  customerReceipts CustomerReceipt[] @relation("CustomerReceipts")

  @@index([cuit])
  @@index([name])
  @@index([status])
  @@index([province])
  @@index([salesPersonId])
  @@map("customers")
}

model Contact {
  id          String   @id @default(cuid())
  customerId  String

  firstName   String
  lastName    String
  position    String?
  email       String?
  phone       String?
  mobile      String?
  isPrimary   Boolean  @default(false)

  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([email])
  @@map("contacts")
}

// ========================================
// PROVEEDORES
// ========================================

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

model Supplier {
  id              String         @id @default(cuid())

  // Información básica
  name            String         // Nombre comercial
  legalName       String?        // Razón social
  taxId           String?        @unique // CUIT

  // Financiero
  discount        Decimal        @default(0) @db.Decimal(5, 2) // Descuento que nos dan (0-100%)
  paymentDays     Int            @default(30) // Días de plazo de pago
  balance         Decimal        @default(0) @db.Decimal(12, 2) // Saldo (lo que les debemos)

  // Contacto
  email           String?
  phone           String?
  mobile          String?
  address         String?
  city            String?
  province        String?
  postalCode      String?
  website         String?

  // Comercial
  paymentTerms    String?        @db.Text // Condiciones de pago
  accountNumber   String?        // Número de cuenta bancaria
  buyerUserId     String?        // Usuario comprador asignado
  buyerUser       User?          @relation("SupplierBuyer", fields: [buyerUserId], references: [id])

  // Clasificación
  category        String?        // Válvulas, Instrumentos, etc.
  brands          String[]       // Marcas que representa (GENEBRE, WINTERS, etc.)

  // Estado
  status          SupplierStatus @default(ACTIVE)
  isPreferred     Boolean        @default(false) // Proveedor preferido

  // Notas
  notes           String?        @db.Text
  internalNotes   String?        @db.Text // Notas privadas internas

  // Relaciones
  products        Product[]         @relation("SupplierProducts")
  purchaseOrders  PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  payments        SupplierPayment[]
  treasuryPayments Payment[]

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([name])
  @@index([taxId])
  @@index([status])
  @@index([buyerUserId])
  @@index([isPreferred])
  @@map("suppliers")
}

// ========================================
// ÓRDENES DE COMPRA Y PAGOS A PROVEEDORES
// ========================================

enum PurchaseOrderStatus {
  DRAFT         // Borrador
  PENDING       // Pendiente de aprobación
  APPROVED      // Aprobada
  RECEIVED      // Recibida
  PARTIALLY_RECEIVED  // Parcialmente recibida
  CANCELLED     // Cancelada
}

model PurchaseOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique

  supplierId      String
  userId          String              // Usuario que crea la orden

  status          PurchaseOrderStatus @default(DRAFT)
  currency        Currency            @default(ARS)

  // Montos
  subtotal        Decimal             @db.Decimal(12, 2)
  taxAmount       Decimal             @db.Decimal(12, 2)
  discount        Decimal             @default(0) @db.Decimal(12, 2)
  total           Decimal             @db.Decimal(12, 2)

  // Fechas
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?           // Fecha esperada de entrega
  receivedDate    DateTime?           // Fecha de recepción

  // Pagos
  paidAmount      Decimal             @default(0) @db.Decimal(12, 2)

  notes           String?             @db.Text

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relaciones
  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  user            User                @relation(fields: [userId], references: [id])
  items           PurchaseOrderItem[]
  payments        SupplierPayment[]
  purchaseInvoices PurchaseInvoice[]

  @@index([supplierId])
  @@index([userId])
  @@index([status])
  @@index([orderNumber])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  productId       String

  quantity        Int
  receivedQty     Int           @default(0)
  unitCost        Decimal       @db.Decimal(12, 2)
  discount        Decimal       @default(0) @db.Decimal(5, 2)
  taxRate         Decimal       @db.Decimal(5, 2)
  subtotal        Decimal       @db.Decimal(12, 2)

  description     String?

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

enum PaymentMethod {
  CASH          // Efectivo
  TRANSFER      // Transferencia
  CHECK         // Cheque
  DEBIT         // Débito
  CREDIT        // Crédito
}

// ========================================
// FACTURAS DE COMPRA A PROVEEDORES
// ========================================

enum PurchaseInvoiceStatus {
  DRAFT         // Borrador
  PENDING       // Pendiente de aprobación
  APPROVED      // Aprobada
  PAID          // Pagada
  CANCELLED     // Anulada
}

model PurchaseInvoice {
  id                    String                @id @default(cuid())
  invoiceNumber         String                @unique  // A00031-00293139

  // Proveedor
  supplierId            String
  supplier              Supplier              @relation(fields: [supplierId], references: [id])

  // Tipo de comprobante
  voucherType           InvoiceType           // A, B, C
  invoiceType           String                @default("FA") // FA (Factura), NC (Nota Crédito), ND (Nota Débito)

  // Fechas
  invoiceDate           DateTime              // Fecha contable
  receiptDate           DateTime              @default(now()) // Fecha de recepción
  dueDate               DateTime              // Fecha de vencimiento

  // Numeración del proveedor
  pointOfSale           String                // 00031
  invoiceNumberSuffix   String                // 00293139

  // AFIP
  cae                   String?               // 86073755026904
  caeExpirationDate     DateTime?             // 23/02/2026

  // Remito y orden asociados
  deliveryNoteNumber    String?               // R00035-00293139
  purchaseOrderId       String?
  purchaseOrder         PurchaseOrder?        @relation(fields: [purchaseOrderId], references: [id])

  // Condiciones comerciales
  paymentTerms          String?               // "Cuenta corriente 30 días"
  generalDiscount       Decimal               @default(0) @db.Decimal(5, 2) // 30%

  // Importes
  subtotal              Decimal               @db.Decimal(15, 2) // Antes de descuento
  discountAmount        Decimal               @default(0) @db.Decimal(15, 2) // Monto del descuento
  netAmount             Decimal               @db.Decimal(15, 2) // Neto gravado (después de descuento)
  notTaxedAmount        Decimal               @default(0) @db.Decimal(15, 2) // No gravado
  exemptAmount          Decimal               @default(0) @db.Decimal(15, 2) // Exento
  taxAmount             Decimal               @db.Decimal(15, 2) // IVA
  perceptionsAmount     Decimal               @default(0) @db.Decimal(15, 2) // Percepciones IIBB
  total                 Decimal               @db.Decimal(15, 2) // Total factura
  balance               Decimal               @db.Decimal(15, 2) // Saldo pendiente de pago

  // Moneda
  currency              String                @default("ARS")
  exchangeRate          Decimal               @default(1) @db.Decimal(12, 6)

  // Estado
  status                PurchaseInvoiceStatus @default(PENDING)
  paymentStatus         PaymentStatus         @default(PENDING)

  // Control de inventario
  stockImpact           Boolean               @default(false)  // Si ya impactó en stock
  stockImpactedAt       DateTime?

  // Contabilidad
  journalEntryId        String?               @unique
  journalEntry          JournalEntry?         @relation(fields: [journalEntryId], references: [id])

  // Notas
  description           String?
  internalNotes         String?               @db.Text

  // Usuario
  createdBy             String
  createdByUser         User                  @relation(fields: [createdBy], references: [id])

  // Relaciones
  items                 PurchaseInvoiceItem[]
  taxes                 PurchaseInvoiceTax[]
  perceptions           PurchaseInvoicePerception[]
  payments              PurchasePayment[]

  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@index([supplierId])
  @@index([invoiceDate])
  @@index([status])
  @@index([createdBy])
  @@map("purchase_invoices")
}

model PurchaseInvoiceItem {
  id                    String              @id @default(cuid())
  purchaseInvoiceId     String
  purchaseInvoice       PurchaseInvoice     @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)

  // Producto
  productId             String?
  product               Product?            @relation(fields: [productId], references: [id])

  // Códigos del proveedor
  supplierProductCode   String?             // 0013028 10 (código del proveedor)
  description           String              // Descripción completa

  // Cantidades
  unit                  String              @default("UN") // UNI, KG, M, etc.
  quantity              Decimal             @db.Decimal(12, 3)

  // Precios
  listPrice             Decimal             @db.Decimal(15, 2) // Precio de lista
  discountPercent       Decimal             @default(0) @db.Decimal(5, 2) // Descuento % aplicado
  unitPrice             Decimal             @db.Decimal(15, 2) // Precio unitario final
  subtotal              Decimal             @db.Decimal(15, 2) // Precio x cantidad

  // IVA
  taxRate               Decimal             @default(21) @db.Decimal(5, 2) // 21%, 10.5%, 27%, 0%
  taxAmount             Decimal             @db.Decimal(15, 2)
  total                 Decimal             @db.Decimal(15, 2)

  // Contabilidad
  accountId             String?             // Cuenta contable (115100 - Mercaderías)
  account               ChartOfAccount?     @relation(fields: [accountId], references: [id])

  // Trazabilidad
  batchNumber           String?             // Número de lote
  expirationDate        DateTime?           // Vencimiento (si aplica)
  importInfo            String?             // "IC04-183058-T Or:ESPAÑA Adu:BS.AS."

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([purchaseInvoiceId])
  @@index([productId])
  @@index([accountId])
  @@map("purchase_invoice_items")
}

model PurchaseInvoiceTax {
  id                    String          @id @default(cuid())
  purchaseInvoiceId     String
  purchaseInvoice       PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)

  taxType               String          // IVA_21, IVA_10_5, IVA_27, IVA_5, IVA_2_5
  rate                  Decimal         @db.Decimal(5, 2) // 21, 10.5, 27, 5, 2.5
  baseAmount            Decimal         @db.Decimal(15, 2) // Base imponible
  taxAmount             Decimal         @db.Decimal(15, 2) // Monto del impuesto

  createdAt             DateTime        @default(now())

  @@index([purchaseInvoiceId])
  @@map("purchase_invoice_taxes")
}

model PurchaseInvoicePerception {
  id                    String              @id @default(cuid())
  purchaseInvoiceId     String
  purchaseInvoice       PurchaseInvoice     @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)

  // Jurisdicción
  jurisdiction          String              // AGIP, BS.AS., JUJUY, SALTA, etc.
  perceptionType        String              // IIBB, Ganancias, SUSS
  regulation            String?             // "352/22 G11", "B1/02", "DPR 974/01"

  // Cálculo
  rate                  Decimal             @db.Decimal(5, 2) // 3.00, 0.70, 1.25, 0.08
  baseAmount            Decimal             @db.Decimal(15, 2) // Base sobre la que se calcula
  amount                Decimal             @db.Decimal(15, 2) // Monto de la percepción

  // Contabilidad
  accountId             String?             // 114301 - Ret y Percepciones Imp IIBB
  account               ChartOfAccount?     @relation(fields: [accountId], references: [id])

  createdAt             DateTime            @default(now())

  @@index([purchaseInvoiceId])
  @@index([accountId])
  @@map("purchase_invoice_perceptions")
}

model PurchasePayment {
  id                    String              @id @default(cuid())

  // Referencia al pago en tesorería
  paymentId             String?             // Pago de tesorería
  payment               Payment?            @relation(fields: [paymentId], references: [id])

  // Factura de compra
  purchaseInvoiceId     String
  purchaseInvoice       PurchaseInvoice     @relation(fields: [purchaseInvoiceId], references: [id])

  // Datos del pago
  amount                Decimal             @db.Decimal(15, 2)
  paymentDate           DateTime            @default(now())
  paymentMethod         PaymentMethod       @default(TRANSFER)
  reference             String?             // Número de cheque, transferencia, etc.
  notes                 String?             @db.Text

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([purchaseInvoiceId])
  @@index([paymentId])
  @@map("purchase_payments")
}

model SupplierPayment {
  id              String         @id @default(cuid())

  supplierId      String
  purchaseOrderId String?        // Opcional: puede ser un pago general
  userId          String         // Usuario que registra el pago

  amount          Decimal        @db.Decimal(12, 2)
  currency        Currency       @default(ARS)
  method          PaymentMethod  @default(TRANSFER)

  paymentDate     DateTime       @default(now())
  reference       String?        // Número de transferencia, cheque, etc.
  notes           String?        @db.Text

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relaciones
  supplier        Supplier       @relation(fields: [supplierId], references: [id])
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  user            User           @relation(fields: [userId], references: [id])

  @@index([supplierId])
  @@index([purchaseOrderId])
  @@index([userId])
  @@index([paymentDate])
  @@map("supplier_payments")
}

// ========================================
// PRODUCTOS
// ========================================

enum ProductStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
}

enum ProductType {
  PRODUCT      // Producto físico con inventario
  SERVICE      // Servicio sin inventario
  COMBO        // Combo de productos
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  parentId    String?

  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([name])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id              String        @id @default(cuid())

  // Identificación
  sku             String        @unique
  name            String
  description     String?       @db.Text

  // Tipo y categorización
  type            ProductType   @default(PRODUCT)
  categoryId      String?
  supplierId      String?       // Proveedor principal del producto
  brand           String?

  // Stock (stock total calculado)
  stockQuantity   Int           @default(0)
  minStock        Int           @default(0)
  maxStock        Int?
  unit            String        @default("UN") // Unidad de medida

  // Costos y precios
  lastCost        Decimal?      @db.Decimal(12, 2) // Último costo de compra
  averageCost     Decimal?      @db.Decimal(12, 2) // Costo promedio calculado
  listPriceUSD    Decimal?      @db.Decimal(12, 2) // Precio lista en USD (para cotizaciones)

  // Configuración
  status          ProductStatus @default(ACTIVE)
  isTaxable       Boolean       @default(true)
  taxRate         Decimal       @default(21) @db.Decimal(5, 2) // IVA 21% default

  // Control de inventario
  trackInventory  Boolean       @default(true)
  allowNegative   Boolean       @default(false)

  // Imágenes y documentos
  images          String[]      @default([]) // Array de URLs

  // Metadatos
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relaciones
  category        Category?              @relation(fields: [categoryId], references: [id])
  supplier        Supplier?              @relation("SupplierProducts", fields: [supplierId], references: [id])
  prices          ProductPrice[]
  quoteItems      QuoteItem[]
  quoteAdditionals QuoteItemAdditional[]
  deliveryNoteItems DeliveryNoteItem[]
  invoiceItems    InvoiceItem[]
  purchaseOrderItems PurchaseOrderItem[]
  purchaseInvoiceItems PurchaseInvoiceItem[]
  stockMovements  StockMovement[]
  warehouseStocks WarehouseStock[]
  priceListItems  PriceListItem[]

  @@index([sku])
  @@index([name])
  @@index([type])
  @@index([categoryId])
  @@index([supplierId])
  @@index([status])
  @@map("products")
}

enum Currency {
  ARS
  USD
  EUR
}

enum PriceType {
  COST      // Precio de costo
  SALE      // Precio de venta
  LIST      // Precio de lista
  WHOLESALE // Precio mayorista
}

model ProductPrice {
  id          String    @id @default(cuid())
  productId   String

  currency    Currency
  priceType   PriceType
  amount      Decimal   @db.Decimal(12, 2)

  // Vigencia
  validFrom   DateTime  @default(now())
  validUntil  DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, currency, priceType, validFrom])
  @@index([productId])
  @@index([currency])
  @@index([priceType])
  @@map("product_prices")
}

// ========================================
// TIPOS DE CAMBIO
// ========================================

enum ExchangeRateSource {
  MANUAL
  BANCO_CENTRAL
  API
}

model ExchangeRate {
  id          String              @id @default(cuid())

  fromCurrency Currency
  toCurrency   Currency
  rate         Decimal             @db.Decimal(12, 6)

  source      ExchangeRateSource  @default(MANUAL)
  validFrom   DateTime            @default(now())
  validUntil  DateTime?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relaciones
  invoices    Invoice[]

  @@unique([fromCurrency, toCurrency, validFrom])
  @@index([fromCurrency, toCurrency])
  @@index([validFrom])
  @@map("exchange_rates")
}

// ========================================
// CRM - OPORTUNIDADES Y COTIZACIONES
// ========================================

enum OpportunityStage {
  LEAD           // Prospecto
  QUALIFIED      // Calificado
  PROPOSAL       // Propuesta enviada
  NEGOTIATION    // Negociación
  CLOSED_WON     // Ganada
  CLOSED_LOST    // Perdida
}

enum OpportunityPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Opportunity {
  id              String              @id @default(cuid())

  customerId      String
  userId          String              // Vendedor asignado

  title           String
  description     String?             @db.Text
  stage           OpportunityStage    @default(LEAD)
  priority        OpportunityPriority @default(MEDIUM)

  estimatedValue  Decimal?            @db.Decimal(12, 2)
  currency        Currency            @default(ARS)
  probability     Int?                // Probabilidad de cierre (0-100)

  expectedCloseDate DateTime?
  closedDate      DateTime?

  lostReason      String?             @db.Text

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  customer        Customer            @relation(fields: [customerId], references: [id])
  user            User                @relation(fields: [userId], references: [id])
  quotes          Quote[]
  activities      Activity[]

  @@index([customerId])
  @@index([userId])
  @@index([stage])
  @@index([expectedCloseDate])
  @@map("opportunities")
}

enum QuoteStatus {
  DRAFT           // Borrador
  SENT            // Enviada al cliente
  ACCEPTED        // Aceptada por el cliente
  REJECTED        // Rechazada por el cliente
  EXPIRED         // Vencida (pasó validUntil)
  CANCELLED       // Cancelada manualmente
  CONVERTED       // Convertida a factura/remito
}

model Quote {
  id              String      @id @default(cuid())
  quoteNumber     String      @unique  // VAL-YYYY-NNN

  customerId      String
  opportunityId   String?
  salesPersonId   String       // Vendedor

  date            DateTime     @default(now())
  status          QuoteStatus  @default(DRAFT)
  currency        Currency     @default(USD)  // VAL ARG factura en USD

  // Tipo de cambio USD->ARS del día
  exchangeRate    Decimal      @db.Decimal(12, 6)

  // Estado y seguimiento
  statusUpdatedAt DateTime?
  statusUpdatedBy String?

  // Respuesta del cliente
  customerResponse     String?   @db.Text    // Comentarios del cliente
  responseDate         DateTime?
  rejectionReason      String?   @db.Text

  // Totales (en USD)
  subtotal        Decimal      @default(0) @db.Decimal(15, 2)
  total           Decimal      @default(0) @db.Decimal(15, 2)

  validUntil      DateTime?
  terms           String?      @db.Text  // Condiciones de pago
  notes           String?      @db.Text  // Notas visibles en PDF
  internalNotes   String?      @db.Text  // Notas internas, no visibles

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  customer        Customer     @relation(fields: [customerId], references: [id])
  opportunity     Opportunity? @relation(fields: [opportunityId], references: [id])
  salesPerson     User         @relation(fields: [salesPersonId], references: [id])
  items           QuoteItem[]
  deliveryNotes   DeliveryNote[]    // Remitos generados
  invoices        Invoice[]         // Facturas generadas
  statusHistory   QuoteStatusHistory[]
  publicToken     QuotePublicToken?  // Token para acceso público
  emailLogs       QuoteEmailLog[]    // Log de emails enviados

  @@index([customerId])
  @@index([opportunityId])
  @@index([salesPersonId])
  @@index([status])
  @@index([quoteNumber])
  @@index([date])
  @@index([validUntil])
  @@map("quotes")
}

model QuoteItem {
  id                    String                 @id @default(cuid())
  quoteId               String
  itemNumber            Int                    // 10, 20, 30, 40... (incrementos de 10)

  productId             String
  description           String?                // Override de descripción

  quantity              Int

  // Precios y descuentos (todo en USD)
  listPrice             Decimal                @db.Decimal(12, 2)  // Precio lista del producto principal
  brandDiscount         Decimal                @default(0) @db.Decimal(5, 3)  // Descuento por marca (0-1, ej: 0.15 = 15%)
  customerMultiplier    Decimal                @default(1) @db.Decimal(5, 3)  // Multiplicador del cliente (ej: 1.2)

  // Precios calculados
  unitPrice             Decimal                @db.Decimal(12, 2)  // Precio unitario calculado
  totalPrice            Decimal                @db.Decimal(15, 2)  // Total del item

  // Plazo de entrega
  deliveryTime          String?                // Plazo de entrega (ej: "Inmediato", "7 días", "15 días")

  // Alternativas (Item 10A, 10B como alternativas de Item 10)
  isAlternative         Boolean                @default(false)
  alternativeToItemId   String?

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  quote                 Quote                  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product               Product                @relation(fields: [productId], references: [id])
  alternativeToItem     QuoteItem?             @relation("ItemAlternatives", fields: [alternativeToItemId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  alternatives          QuoteItem[]            @relation("ItemAlternatives")
  additionals           QuoteItemAdditional[]

  @@index([quoteId])
  @@index([productId])
  @@index([itemNumber])
  @@index([alternativeToItemId])
  @@map("quote_items")
}

// Adicionales: hasta 5 productos complementarios por item
model QuoteItemAdditional {
  id          String     @id @default(cuid())
  quoteItemId String
  productId   String
  position    Int        // 1-5 (Adicional 1, 2, 3, 4, 5)
  listPrice   Decimal    @db.Decimal(12, 2)  // Precio del adicional en USD

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  quoteItem   QuoteItem  @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  product     Product    @relation(fields: [productId], references: [id])

  @@index([quoteItemId])
  @@index([productId])
  @@map("quote_item_additionals")
}

// Descuentos por marca
model BrandDiscount {
  id               String   @id @default(cuid())
  brand            String   @unique  // GENEBRE, WINTERS, CEPEX, etc.
  discountPercent  Decimal  @db.Decimal(5, 2)  // 0-100 (ej: 15 = 15%)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([brand])
  @@map("brand_discounts")
}

// Historial de cambios de estado de cotizaciones
model QuoteStatusHistory {
  id          String      @id @default(cuid())
  quoteId     String
  fromStatus  QuoteStatus
  toStatus    QuoteStatus
  changedBy   String      // User ID
  notes       String?     @db.Text
  createdAt   DateTime    @default(now())

  quote       Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([createdAt])
  @@map("quote_status_history")
}

// Token público para acceso a cotizaciones sin login
model QuotePublicToken {
  id          String      @id @default(cuid())
  quoteId     String      @unique
  token       String      @unique
  expiresAt   DateTime
  createdAt   DateTime    @default(now())

  quote       Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("quote_public_tokens")
}

// Log de emails enviados para cotizaciones
model QuoteEmailLog {
  id              String      @id @default(cuid())
  quoteId         String
  recipientEmail  String
  subject         String
  status          String      // 'sent', 'failed'
  emailId         String?     // ID del email en Resend
  publicToken     String?     // Token asociado
  error           String?     @db.Text
  createdAt       DateTime    @default(now())

  quote           Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([status])
  @@index([createdAt])
  @@map("quote_email_logs")
}

// ========================================
// REMITOS / DELIVERY NOTES
// ========================================

enum DeliveryNoteStatus {
  PENDING           // Pendiente de preparar
  PREPARING         // En preparación
  READY             // Listo para despachar
  DISPATCHED        // Despachado
  DELIVERED         // Entregado
  CANCELLED         // Cancelado
}

model DeliveryNote {
  id                String             @id @default(cuid())
  deliveryNumber    String             @unique  // 0001-00000001

  // Origen
  quoteId           String?
  quote             Quote?             @relation(fields: [quoteId], references: [id])

  // Cliente
  customerId        String
  customer          Customer           @relation(fields: [customerId], references: [id])

  // Fechas
  date              DateTime           @default(now())
  deliveryDate      DateTime?          // Fecha real de entrega

  // Dirección de entrega
  deliveryAddress   String?
  deliveryCity      String?
  deliveryProvince  String?
  deliveryPostalCode String?

  // Estado
  status            DeliveryNoteStatus @default(PENDING)

  // Transporte
  carrier           String?            // Transportista
  trackingNumber    String?            // Número de seguimiento

  // Responsables
  preparedBy        String?            // Quién preparó el pedido
  deliveredBy       String?            // Quién entregó
  receivedBy        String?            // Quién recibió (firma cliente)

  // Notas
  notes             String?            @db.Text
  internalNotes     String?            @db.Text

  // Items
  items             DeliveryNoteItem[]

  // Facturación
  invoices          Invoice[]          // Facturas generadas desde este remito

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([deliveryNumber])
  @@index([customerId])
  @@index([quoteId])
  @@index([status])
  @@index([date])
  @@map("delivery_notes")
}

model DeliveryNoteItem {
  id                String        @id @default(cuid())
  deliveryNoteId    String
  deliveryNote      DeliveryNote  @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)

  productId         String
  product           Product       @relation(fields: [productId], references: [id])

  description       String
  quantity          Int

  // Ubicación en depósito
  warehouseLocation String?
  batchNumber       String?       // Número de lote
  serialNumber      String?       // Número de serie

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([deliveryNoteId])
  @@index([productId])
  @@map("delivery_note_items")
}

// ========================================
// FACTURACIÓN
// ========================================

enum InvoiceType {
  A  // Factura A
  B  // Factura B
  C  // Factura C
  E  // Factura E (Exportación)
}

enum TransactionType {
  SALE       // Venta a cliente
  PURCHASE   // Compra a proveedor
}

enum InvoiceStatus {
  DRAFT
  PENDING      // Pendiente de emisión
  AUTHORIZED   // Autorizada por AFIP
  SENT         // Enviada al cliente
  PAID
  OVERDUE      // Vencida
  CANCELLED
}

enum AfipStatus {
  PENDING           // Pendiente de enviar
  SENT              // Enviada a AFIP
  APPROVED          // Aprobada (con CAE)
  REJECTED          // Rechazada por AFIP
  ERROR             // Error al enviar
}

enum InvoicePaymentStatus {
  UNPAID            // Impaga
  PARTIAL           // Pago parcial
  PAID              // Pagada
}

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  invoiceType     InvoiceType
  transactionType TransactionType @default(SALE)

  // Origen
  customerId      String
  quoteId         String?       // Puede haber varias facturas de una cotización
  deliveryNoteId  String?       // Factura generada desde un remito
  userId          String

  status          InvoiceStatus @default(DRAFT)
  currency        Currency      @default(ARS)

  // Montos en moneda original
  subtotal        Decimal       @db.Decimal(12, 2)
  taxAmount       Decimal       @db.Decimal(12, 2)
  discount        Decimal       @default(0) @db.Decimal(12, 2)
  total           Decimal       @db.Decimal(12, 2)
  balance         Decimal       @default(0) @db.Decimal(12, 2) // Saldo pendiente

  // Tipo de cambio para contabilidad (solo si currency != ARS)
  exchangeRate    Decimal?      @db.Decimal(12, 6)  // TC usado para convertir a ARS
  exchangeRateId  String?       // Referencia al ExchangeRate usado

  // AFIP
  cae             String?       // Código de Autorización Electrónico
  caeExpiration   DateTime?
  afipStatus      AfipStatus    @default(PENDING)
  afipError       String?       @db.Text

  // Estado de pago
  paymentStatus   InvoicePaymentStatus @default(UNPAID)

  issueDate       DateTime      @default(now())
  dueDate         DateTime
  paidDate        DateTime?

  notes           String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  customer        Customer       @relation(fields: [customerId], references: [id])
  quote           Quote?         @relation(fields: [quoteId], references: [id])
  deliveryNote    DeliveryNote?  @relation(fields: [deliveryNoteId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
  exchangeRateRef ExchangeRate?  @relation(fields: [exchangeRateId], references: [id])
  items           InvoiceItem[]

  // Accounting relations
  journalEntries  JournalEntry[]
  ivaBooks        IVABook[]
  taxWithholdings TaxWithholding[]
  customerReceipts CustomerReceipt[]

  // Inventory relations
  stockMovements  StockMovement[]

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([transactionType])
  @@index([invoiceNumber])
  @@index([issueDate])
  @@index([dueDate])
  @@index([quoteId])
  @@index([deliveryNoteId])
  @@index([afipStatus])
  @@index([paymentStatus])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  productId   String

  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discount    Decimal @default(0) @db.Decimal(5, 2)
  taxRate     Decimal @db.Decimal(5, 2)
  subtotal    Decimal @db.Decimal(12, 2)

  description String?

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([productId])
  @@map("invoice_items")
}

// ========================================
// ACTIVIDADES Y AUDIT LOG
// ========================================

enum ActivityType {
  CUSTOMER_CREATED
  CUSTOMER_UPDATED
  CUSTOMER_DELETED
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_DELETED
  OPPORTUNITY_CREATED
  OPPORTUNITY_UPDATED
  OPPORTUNITY_STAGE_CHANGED
  QUOTE_CREATED
  QUOTE_SENT
  QUOTE_ACCEPTED
  QUOTE_REJECTED
  INVOICE_CREATED
  INVOICE_SENT
  INVOICE_PAID
  NOTE_ADDED
  EMAIL_SENT
  CALL_LOGGED
  MEETING_SCHEDULED
  EXCHANGE_RATE_CREATED
  EXCHANGE_RATE_UPDATED
  EXCHANGE_RATE_DELETED
}

model Activity {
  id              String       @id @default(cuid())

  type            ActivityType
  userId          String

  // Relación polimórfica
  entityType      String       // "customer", "opportunity", "quote", etc.
  entityId        String

  customerId      String?
  opportunityId   String?

  title           String
  description     String?      @db.Text
  metadata        Json?        // Datos adicionales en JSON

  createdAt       DateTime     @default(now())

  user            User         @relation(fields: [userId], references: [id])
  customer        Customer?    @relation(fields: [customerId], references: [id])
  opportunity     Opportunity? @relation(fields: [opportunityId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([customerId])
  @@index([opportunityId])
  @@index([createdAt])
  @@map("activities")
}

// ========================================
// MÓDULO DE CONTABILIDAD ARGENTINA
// ========================================

// Plan de Cuentas Contable
enum AccountType {
  ACTIVO              // Activo
  PASIVO              // Pasivo
  PATRIMONIO_NETO     // Patrimonio Neto
  INGRESO             // Ingresos
  EGRESO              // Egresos/Costos/Gastos
}

// ========================================
// MÓDULO DE INVENTARIO
// ========================================

enum StockMovementType {
  COMPRA                // Compra a proveedor (entrada)
  VENTA                 // Venta a cliente (salida automática)
  AJUSTE_POSITIVO       // Ajuste manual - incremento
  AJUSTE_NEGATIVO       // Ajuste manual - decremento
  DEVOLUCION_CLIENTE    // Devolución de cliente (entrada)
  DEVOLUCION_PROVEEDOR  // Devolución a proveedor (salida)
  TRANSFERENCIA         // Transferencia entre depósitos
}

// Depósitos / Almacenes
model Warehouse {
  id              String    @id @default(cuid())
  code            String    @unique
  name            String
  description     String?
  address         String?
  isActive        Boolean   @default(true)
  isDefault       Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  warehouseStocks WarehouseStock[]
  stockMovements  StockMovement[]

  @@index([code])
  @@index([isActive])
  @@map("warehouses")
}

// Stock por depósito
model WarehouseStock {
  id              String    @id @default(cuid())
  warehouseId     String
  productId       String

  quantity        Int       @default(0)
  minStock        Int       @default(0)
  maxStock        Int?

  lastUpdated     DateTime  @default(now())

  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
  @@map("warehouse_stocks")
}

// Listas de precios
model PriceList {
  id              String    @id @default(cuid())
  name            String
  description     String?
  isActive        Boolean   @default(true)
  isDefault       Boolean   @default(false)

  validFrom       DateTime  @default(now())
  validUntil      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  priceListItems  PriceListItem[]

  @@index([name])
  @@index([isActive])
  @@map("price_lists")
}

// Items de lista de precios
model PriceListItem {
  id              String    @id @default(cuid())
  priceListId     String
  productId       String

  price           Decimal   @db.Decimal(12, 2)
  currency        Currency  @default(ARS)

  priceList       PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([priceListId, productId])
  @@index([priceListId])
  @@index([productId])
  @@map("price_list_items")
}

model ChartOfAccount {
  id              String      @id @default(cuid())
  code            String      @unique  // Ej: 1.1.1.001
  name            String
  accountType     AccountType
  category        String?     // CAJA_Y_BANCOS, CREDITOS_VENTAS, etc.
  parentId        String?
  level           Int         // 1, 2, 3, 4 (niveles de jerarquía)

  // Control
  isActive        Boolean     @default(true)
  isDetailAccount Boolean     @default(false)  // Si permite movimientos (nivel más bajo)
  acceptsEntries  Boolean     @default(true)   // Si acepta asientos directos (deprecated, usar isDetailAccount)

  // Saldos (calculados)
  debitBalance    Decimal     @default(0) @db.Decimal(15, 2)
  creditBalance   Decimal     @default(0) @db.Decimal(15, 2)

  parent          ChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children        ChartOfAccount[] @relation("AccountHierarchy")

  journalEntryLines JournalEntryLine[]
  journalEntryTemplateLines JournalEntryTemplateLine[]
  purchaseInvoiceItems PurchaseInvoiceItem[]
  purchaseInvoicePerceptions PurchaseInvoicePerception[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([accountType])
  @@index([parentId])
  @@index([category])
  @@map("chart_of_accounts")
}

// ========================================
// PLANTILLAS DE ASIENTOS CONTABLES
// ========================================

enum TriggerType {
  SALE_INVOICE          // Factura de venta
  PURCHASE_INVOICE      // Factura de compra
  CUSTOMER_PAYMENT      // Cobro a cliente
  SUPPLIER_PAYMENT      // Pago a proveedor
  BANK_TRANSFER         // Transferencia bancaria
  LOAN_DISBURSEMENT     // Desembolso de préstamo
  LOAN_PAYMENT          // Pago de cuota de préstamo
  EXPENSE               // Gasto
  SALARY_PAYMENT        // Pago de sueldo
  DEPRECIATION          // Depreciación
  INVENTORY_ADJUSTMENT  // Ajuste de inventario
  OPENING_ENTRY         // Asiento de apertura
  CLOSING_ENTRY         // Asiento de cierre
  MANUAL                // Asiento manual
}

enum EntryLineSide {
  DEBIT       // Debe
  CREDIT      // Haber
}

enum AmountType {
  TOTAL           // Total del documento (ej: total factura)
  SUBTOTAL        // Subtotal sin impuestos
  TAX             // Impuestos (IVA)
  TAX_21          // IVA 21%
  TAX_10_5        // IVA 10.5%
  PERCEPTION      // Percepciones
  FIXED           // Monto fijo
  PERCENTAGE      // Porcentaje del total
  BALANCE         // Saldo restante
  PRINCIPAL       // Capital de préstamo
  INTEREST        // Intereses
  NET_PAYMENT     // Pago neto (después de retenciones)
  RETENTION       // Retenciones
  CUSTOM          // Campo personalizado
}

model JournalEntryTemplate {
  id              String                      @id @default(cuid())
  name            String                      // "Factura de Venta Tipo A"
  code            String                      @unique // "SALE_INVOICE_A"
  triggerType     TriggerType                 // SALE_INVOICE, PURCHASE_INVOICE, etc.
  description     String?
  isActive        Boolean                     @default(true)

  // Líneas de la plantilla
  lines           JournalEntryTemplateLine[]

  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt

  @@index([code])
  @@index([triggerType])
  @@index([isActive])
  @@map("journal_entry_templates")
}

model JournalEntryTemplateLine {
  id          String                  @id @default(cuid())
  templateId  String
  template    JournalEntryTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)

  lineNumber  Int                     // Orden
  accountId   String                  // Cuenta a afectar
  account     ChartOfAccount          @relation(fields: [accountId], references: [id])

  side        EntryLineSide           // DEBIT o CREDIT
  amountType  AmountType              // TOTAL, SUBTOTAL, TAX, FIXED, PERCENTAGE

  // Para montos fijos o porcentajes
  fixedAmount Decimal?                @db.Decimal(15, 2)
  percentage  Decimal?                @db.Decimal(5, 2)

  description String?                 // Descripción de la línea

  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([templateId])
  @@index([accountId])
  @@map("journal_entry_template_lines")
}

// ========================================
// ASIENTOS CONTABLES
// ========================================

enum JournalEntryStatus {
  DRAFT      // Borrador
  POSTED     // Contabilizado
  VOIDED     // Anulado
}

model JournalEntry {
  id              String              @id @default(cuid())
  entryNumber     Int                 @unique @default(autoincrement())
  date            DateTime            @default(now())
  description     String
  reference       String?             // Referencia externa

  // Relación con documentos
  invoiceId       String?
  paymentId       String?
  purchaseInvoice PurchaseInvoice?

  // Plantilla aplicada
  templateCode    String?             // Código de plantilla utilizada
  triggerType     TriggerType?        // Tipo de operación que disparó el asiento
  isAutomatic     Boolean             @default(false)  // Si fue generado automáticamente

  status          JournalEntryStatus  @default(DRAFT)
  userId          String

  lines           JournalEntryLine[]
  stockMovements  StockMovement[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])
  invoice         Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([entryNumber])
  @@index([date])
  @@index([status])
  @@index([userId])
  @@index([invoiceId])
  @@map("journal_entries")
}

// Líneas de Asiento (Debe y Haber)
model JournalEntryLine {
  id              String   @id @default(cuid())
  journalEntryId  String
  accountId       String

  debit           Decimal  @default(0) @db.Decimal(15, 2)
  credit          Decimal  @default(0) @db.Decimal(15, 2)
  description     String?

  journalEntry    JournalEntry    @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account         ChartOfAccount  @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_entry_lines")
}

// Libro IVA
enum IVABookType {
  COMPRAS  // Libro IVA Compras
  VENTAS   // Libro IVA Ventas
}

model IVABook {
  id              String      @id @default(cuid())
  bookType        IVABookType
  period          String      // YYYY-MM formato

  invoiceId       String      @unique
  date            DateTime
  pointOfSale     String      // Punto de Venta
  invoiceNumber   String
  invoiceType     String      // A, B, C, E

  documentType    String      // CUIT, DNI, etc.
  documentNumber  String
  businessName    String

  // Importes
  netAmount       Decimal  @db.Decimal(15, 2)
  notTaxed        Decimal  @default(0) @db.Decimal(15, 2)
  exempt          Decimal  @default(0) @db.Decimal(15, 2)

  // IVA por alícuota
  iva21           Decimal  @default(0) @db.Decimal(15, 2)
  iva105          Decimal  @default(0) @db.Decimal(15, 2)
  iva27           Decimal  @default(0) @db.Decimal(15, 2)
  iva05           Decimal  @default(0) @db.Decimal(15, 2)

  // Otros conceptos
  perceptions     Decimal  @default(0) @db.Decimal(15, 2)
  otherTaxes      Decimal  @default(0) @db.Decimal(15, 2)
  total           Decimal  @db.Decimal(15, 2)

  invoice         Invoice  @relation(fields: [invoiceId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([bookType])
  @@index([period])
  @@index([date])
  @@map("iva_books")
}

// Percepciones y Retenciones
enum WithholdingType {
  PERCEPCION  // Percepción
  RETENCION   // Retención
}

enum TaxTypeEnum {
  IVA          // Retención/Percepción IVA
  GANANCIAS    // Retención Ganancias
  IIBB         // Retención/Percepción IIBB
  SUSS         // SUSS (Sistema Único de Seguridad Social)
  OTROS        // Otros impuestos
}

model TaxWithholding {
  id              String          @id @default(cuid())
  type            WithholdingType

  invoiceId       String
  taxType         TaxTypeEnum
  jurisdiction    String?         // Jurisdicción (para IIBB)

  taxableAmount   Decimal  @db.Decimal(15, 2)
  rate            Decimal  @db.Decimal(5, 2)
  amount          Decimal  @db.Decimal(15, 2)

  certificateNumber String?
  date            DateTime

  invoice         Invoice  @relation(fields: [invoiceId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([invoiceId])
  @@index([type])
  @@index([taxType])
  @@index([date])
  @@map("tax_withholdings")
}

// Movimientos de Stock
model StockMovement {
  id              String            @id @default(cuid())

  // Relaciones
  productId       String
  warehouseId     String?           // Depósito origen
  invoiceId       String?           // Si es VENTA
  userId          String            // Quien hizo el movimiento

  // Tipo y cantidad
  type            StockMovementType
  quantity        Int               // Positivo = entrada, Negativo = salida

  // Costeo (para CMV)
  unitCost        Decimal           @db.Decimal(12, 2)
  totalCost       Decimal           @db.Decimal(12, 2)
  currency        Currency          @default(ARS)

  // Snapshot de stock
  stockBefore     Int
  stockAfter      Int

  // Contabilidad
  journalEntryId  String?           // Asiento generado (si aplica)

  // Metadatos
  reference       String?
  notes           String?           @db.Text
  date            DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relaciones
  product         Product           @relation(fields: [productId], references: [id])
  warehouse       Warehouse?        @relation(fields: [warehouseId], references: [id])
  invoice         Invoice?          @relation(fields: [invoiceId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
  journalEntry    JournalEntry?     @relation(fields: [journalEntryId], references: [id])

  @@index([productId])
  @@index([warehouseId])
  @@index([invoiceId])
  @@index([userId])
  @@index([type])
  @@index([date])
  @@index([createdAt])
  @@map("stock_movements")
}

// ========================================
// CONFIGURACIÓN DE EMPRESA
// ========================================

model CompanySettings {
  id                    String   @id @default(cuid())

  // Datos generales
  name                  String
  legalName             String
  address               String
  city                  String
  province              String
  postalCode            String
  country               String   @default("Argentina")
  phone                 String
  email                 String
  cbu                   String?
  taxId                 String   // CUIT
  iibbNumber            String?

  // Logo
  logoUrl               String?
  logoWidth             Int?     // en mm
  logoHeight            Int?     // en mm

  // Datos impositivos
  taxCondition          TaxCondition @default(RESPONSABLE_INSCRIPTO)
  fiscalDebitAccount    String?
  fiscalCreditAccount   String?

  // Agentes de retención
  isWithholdingAgent    Boolean  @default(false)
  withholdingGananciasAccount String?
  withholdingIIBB       Boolean  @default(false)
  withholdingIIBBAccount String?
  withholdingIVA        Boolean  @default(false)
  withholdingIVAAccount String?
  withholdingARBA       Boolean  @default(false)
  autoCalculateAGIP     Boolean  @default(false)

  // Retenciones sufridas
  retentionGananciasAccount String?
  retentionIVAAccount       String?
  retentionSUSSAccount      String?

  // Percepciones sufridas
  perceptionIVAAccount      String?

  // Clientes/Proveedores
  customerDefaultAccount      String?
  customerAdvanceAccount      String?
  customerInterestAccount     String?
  customerDiscountAccount     String?
  customerExchangeAccount     String?

  supplierDefaultAccount      String?
  supplierAdvanceAccount      String?
  supplierInterestAccount     String?
  supplierDiscountAccount     String?
  supplierExchangeAccount     String?

  // Avisos de vencimiento
  invoiceReminder1Enabled     Boolean  @default(true)
  invoiceReminder1Days        Int      @default(1)
  invoiceReminder1Before      Boolean  @default(false)
  invoiceReminder2Enabled     Boolean  @default(true)
  invoiceReminder2Days        Int      @default(7)
  invoiceReminder2Before      Boolean  @default(false)
  invoiceReminder3Enabled     Boolean  @default(true)
  invoiceReminder3Days        Int      @default(10)
  invoiceReminder3Before      Boolean  @default(false)

  autoSendReceipts            Boolean  @default(true)
  autoSendPaymentOrders       Boolean  @default(false)

  // Tesorería
  valuesToDepositAccount      String?
  deferredChecksAccount       String?

  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("company_settings")
}

enum NumberingMethod {
  MANUAL
  AUTOMATIC
}

model InvoiceNumbering {
  id                String   @id @default(cuid())
  description       String
  prefix            String   // 0001, 0002, etc.
  numberFrom        Int
  numberTo          Int
  currentNumber     Int
  isDefault         Boolean  @default(false)

  // Método de numeración
  numberingMethod   NumberingMethod @default(AUTOMATIC)

  // Tipos de comprobante
  isSaleInvoice     Boolean  @default(false)
  isDebitNote       Boolean  @default(false)
  isCreditNote      Boolean  @default(false)
  isPaymentOrder    Boolean  @default(false)
  isReceipt         Boolean  @default(false)
  isRemittance      Boolean  @default(false)
  isElectronic      Boolean  @default(false)

  voucherType       String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("invoice_numbering")
}

enum CheckType {
  COMMON
  DEFERRED
  THIRD_PARTY
}

enum CheckStatus {
  PENDING
  CLEARED
  BOUNCED
  CANCELLED
}

model BankCheckbook {
  id          String   @id @default(cuid())
  bankName    String
  accountNumber String
  checkFrom   Int
  checkTo     Int
  currentCheck Int

  checks      Check[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("bank_checkbooks")
}

model Check {
  id            String      @id @default(cuid())
  checkbookId   String
  checkbook     BankCheckbook @relation(fields: [checkbookId], references: [id], onDelete: Cascade)
  checkNumber   String
  paymentDate   DateTime
  type          CheckType
  amount        Decimal     @db.Decimal(12, 2)
  status        CheckStatus @default(PENDING)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([checkbookId])
  @@map("checks")
}

// ========================================
// MÓDULO DE TESORERÍA
// ========================================

enum BankAccountType {
  CASH              // Caja
  CHECKING_ACCOUNT  // Cuenta Corriente
  SAVINGS_ACCOUNT   // Caja de Ahorro
  CREDIT_CARD       // Tarjeta de Crédito
  FOREIGN_CURRENCY  // Moneda Extranjera
}

model BankAccount {
  id                String            @id @default(cuid())
  name              String            // "Cta Cte Galicia"
  type              BankAccountType
  bank              String?           // "Banco Galicia"
  accountNumber     String?
  cbu               String?
  alias             String?

  // Saldos
  balance           Decimal           @default(0) @db.Decimal(15, 2)
  reconciledBalance Decimal           @default(0) @db.Decimal(15, 2)

  // Moneda extranjera
  currency          String            @default("ARS") // ARS, USD, EUR
  currencyBalance   Decimal?          @db.Decimal(15, 2) // Saldo en moneda original

  // Conexión bancaria
  isConnected       Boolean           @default(false)
  bankConnectionId  String?

  // Estado
  isActive          Boolean           @default(true)

  // Relaciones
  transactions      BankTransaction[]
  payments          Payment[]
  receipts          Receipt[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([name])
  @@index([type])
  @@index([isActive])
  @@map("bank_accounts")
}

enum BankTransactionType {
  INCOME            // Ingreso
  EXPENSE           // Egreso
  TRANSFER          // Transferencia entre cuentas
  DEPOSIT           // Depósito
  WITHDRAWAL        // Extracción
  CHECK_CLEARING    // Cobro de cheque
  CHECK_PAYMENT     // Pago con cheque
  CARD_PAYMENT      // Pago con tarjeta
  BANK_FEE          // Comisión bancaria
  INTEREST          // Intereses
}

model BankTransaction {
  id                String          @id @default(cuid())
  bankAccountId     String
  bankAccount       BankAccount     @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  // Datos del movimiento
  date              DateTime
  type              BankTransactionType
  voucherType       String?         // REC, PAG, DEP, EXT, etc.
  voucherNumber     String?
  checkNumber       String?

  // Contraparte
  entityType        String?         // CUSTOMER, SUPPLIER
  entityId          String?
  entityName        String?

  // Importes
  description       String?
  debit             Decimal         @default(0) @db.Decimal(15, 2) // Ingreso
  credit            Decimal         @default(0) @db.Decimal(15, 2) // Egreso
  balance           Decimal         @db.Decimal(15, 2) // Saldo después del movimiento

  // Conciliación
  isReconciled      Boolean         @default(false)
  reconciledAt      DateTime?

  // Relaciones
  invoiceId         String?
  paymentId         String?
  receiptId         String?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([bankAccountId, date])
  @@index([date])
  @@index([entityId])
  @@map("bank_transactions")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model Payment {
  id                String          @id @default(cuid())
  paymentNumber     String          @unique
  date              DateTime        @default(now())

  // A quién se paga
  supplierId        String?
  supplier          Supplier?       @relation(fields: [supplierId], references: [id])

  // Método de pago
  bankAccountId     String?
  bankAccount       BankAccount?    @relation(fields: [bankAccountId], references: [id])

  paymentMethod     PaymentMethod

  // Monto
  amount            Decimal         @db.Decimal(15, 2)
  currency          String          @default("ARS")

  // Detalles
  description       String?
  checkNumber       String?

  // Estado
  status            PaymentStatus   @default(PENDING)

  // Relaciones
  purchasePayments  PurchasePayment[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([paymentNumber])
  @@index([supplierId])
  @@index([bankAccountId])
  @@index([date])
  @@map("payments")
}

model Receipt {
  id                String          @id @default(cuid())
  receiptNumber     String          @unique
  date              DateTime        @default(now())

  // De quién se cobra
  customerId        String?
  customer          Customer?       @relation(fields: [customerId], references: [id])

  // Método de cobro
  bankAccountId     String?
  bankAccount       BankAccount?    @relation(fields: [bankAccountId], references: [id])

  collectionMethod  PaymentMethod

  // Monto
  amount            Decimal         @db.Decimal(15, 2)
  currency          String          @default("ARS")

  // Detalles
  description       String?
  checkNumber       String?

  // Estado
  status            PaymentStatus   @default(PENDING)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([receiptNumber])
  @@index([customerId])
  @@index([bankAccountId])
  @@index([date])
  @@map("receipts")
}

// Cobros a clientes (con integración contable)
model CustomerReceipt {
  id            String        @id @default(cuid())
  customerId    String
  customer      Customer      @relation("CustomerReceipts", fields: [customerId], references: [id])

  // Factura asociada (opcional)
  invoiceId     String?
  invoice       Invoice?      @relation(fields: [invoiceId], references: [id])

  amount        Decimal       @db.Decimal(15, 2)
  currency      String        @default("ARS")
  receiptDate   DateTime      @default(now())
  method        String        // CASH, TRANSFER, DEBIT, CREDIT, CHECK
  reference     String?       // Número de cheque, transferencia, etc.
  notes         String?

  // Usuario que registró el cobro
  userId        String
  user          User          @relation(fields: [userId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([customerId])
  @@index([invoiceId])
  @@index([receiptDate])
  @@map("customer_receipts")
}
